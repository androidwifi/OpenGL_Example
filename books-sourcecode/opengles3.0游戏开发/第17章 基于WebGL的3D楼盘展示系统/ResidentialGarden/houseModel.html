<html><head>	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />  <title>楼房模型</title>  <!--库js的引入-->  	<script type="text/javascript" src="js/util/Matrix.js"></script>	<script type="text/javascript" src="js/util/MatrixState.js"></script>		<script type="text/javascript" src="js/util/GLUtil.js"></script>		<script type="text/javascript" src="js/util/LoadShaderUtil.js"></script>	<script type="text/javascript" src="js/util/LoadObjUtil.js"></script>	<script type="text/javascript" src="js/util/ObjObject.js"></script>	<script type="text/javascript" src="js/util/LightManager.js"></script>	<script type="text/javascript" src="js/util/FrameGlobalVar.js"></script>	<!--应用特有js的引入-->	<script type="text/javascript" src="js/grassmaps/maps7.js"></script>		<script type="text/javascript" src="js/houseModel/HouseModelVar.js"></script>	<script type="text/javascript" src="js/houseModel/loadHouseObj.js"></script>	<script type="text/javascript" src="js/houseModel/DrawButton.js"></script>	<script type="text/javascript" src="js/loadObject.js"></script>	<script type="text/javascript" src="js/PointTransformUtil.js"></script>		<script type="text/javascript" src="js/loadPalntObj.js"></script>	  	<script>    var mPreviousX;//上次的触控位置X坐标	var mPreviousY;//上次的触控位置Y坐标	var down=false;//鼠标按下的标志位	var step=0;//加载步数		document.onmousedown = function(event)	{		mPreviousX=event.pageX;//获取触控点x坐标		mPreviousY=event.pageY;//获取触控点y坐标		var mouseX=fromScreenTo2DWordX(mPreviousX);		var mouseY=fromScreenTo2DWordY(mPreviousY);		//alert("mouseX="+mouseX+";mouseY="+mouseY);		if((mouseX>ONEROOM_MINX&&mouseX<ONEROOM_MAXX)		&&(mouseY>ONEROOM_MINY&&mouseY<ONEROOM_MAXY))//判断是否点中一室一厅按钮		{			ONE=1;//点中后的图片索引值			isRoomType=true;//打开户型页面标志位			roomTypeIndex=0;//户型id-0-一室一厅		}else if((mouseX>TOWROOM_MINX&&mouseX<TOWROOM_MAXX)		&&(mouseY>TOWROOM_MINY&&mouseY<TOWROOM_MAXY))//判断是否点中二室一厅按钮		{			TWO=3;//点中后的图片索引值			isRoomType=true;//打开户型页面标志位			roomTypeIndex=1;//户型id-1-二室一厅		}else if((mouseX>THREEROOM_MINX&&mouseX<THREEROOM_MAXX)		&&(mouseY>THREEROOM_MINY&&mouseY<THREEROOM_MAXY))//判断是否点中三室一厅按钮		{			THREE=5;//点中后的图片索引值			isRoomType=true;//打开户型页面标志位			roomTypeIndex=2//户型id-2-三室一厅		}else if((mouseX>return_minX&&mouseX<return_maxX)				&&(mouseY>return_minY&&mouseY<return_maxY))//判断是否点中返回按钮		{			isReturn=true;//返回主界面标志位		}		down=true;//按下鼠标标志位	}	document.onmousemove = function(event)//onmousemove	{			if(down)//按下鼠标		{			var moveX=event.pageX;//获取移动点x坐标			var moveY=event.pageY;//获取移动点y坐标			var dx = moveX- mPreviousX;//计算触控笔X位移			var dy = moveY- mPreviousY;//计算触控笔y位移			//不超过阈值不移动摄像机			if(Math.abs(dx)<7&& Math.abs(dy)<7){			//alert("==return===");				return;			}						angdegAzimuth += dx * TOUCH_SCALE_FACTOR;//设置沿y轴旋转角度			angdegElevation += dy * TOUCH_SCALE_FACTOR;//设置沿x轴旋转角度			//将仰角限制在5～90度范围内			angdegElevation = Math.max(angdegElevation, 5);			angdegElevation = Math.min(angdegElevation, 90);			//设置摄像机的位置			LookAroundCamera();		}		mPreviousX=event.pageX;//获取移动点x坐标		mPreviousY=event.pageY;//获取移动点y坐标	}	document.onmouseup = function(event)	{		mPreviousX=event.pageX;//获取移动点x坐标		mPreviousY=event.pageY;//获取移动点y坐标		down=false;//抬起鼠标标志位	}	//初始化的方法  	function start()	{    				var url=window.location .href;		var aa=url.indexOf('=');//找到url中"="的索引		if (aa>-1){//如果url中存在"="			uriIndex=url.substring(aa+1);//得到"="后面的内容		}	    //获取GLES上下文	    gl = initWebGLCanvas("bncanvas");	    if (!gl) 	    {			alert("创建GLES上下文失败!");			return;	    }    	    //初始化3D画布参数	    canvas = document.getElementById('bncanvas');				//设置视口	    gl.viewport(0, 0, canvas.width, canvas.height);		var ratio=canvas.width/canvas.height;			    //设置屏幕背景色RGBA		gl.clearColor(0.886,0.851,0.82,1.0); 		//打开背面剪裁		gl.enable(gl.CULL_FACE);		gl.enable(gl.DEPTH_TEST);//打开深度检测						//初始化2D变化矩阵		ms2D.setInitStack();		ms2D.setProjectOrtho(-ratio,ratio,-Vtop,Vtop,V2Dnear,Vfar);//设置投影		ms2D.setCamera(0,0,1,0,0,0,0,1,0);//设置摄像机				//初始化变换矩阵	    ms.setInitStack();	    //设置投影	    ms.setProjectFrustum(-ratio,ratio,-Vtop,Vtop,Vnear,Vfar);			//开启深度检测	    gl.enable(gl.DEPTH_TEST);	    //绘制画面	    setInterval("drawFrame();",10);	}	//设置摄像机位置的方法	function LookAroundCamera()	{		//计算当前观察角度下摄像机的位置		var angradAzimuth = angdegAzimuth*0.017453;//方位角		var angradElevation = angdegElevation*0.017453;//仰角（弧度）				cameraX = (targetX - currSightDis * Math.cos(angradElevation)* Math.sin(angradAzimuth));		cameraY = (targetY + currSightDis * Math.sin(angradElevation));		cameraZ =  (targetZ - currSightDis * Math.cos(angradElevation) * Math.cos(angradAzimuth));				tempx=Math.sin(angradAzimuth)*tempLimit;		tempz=Math.cos(angradAzimuth)*tempLimit;		//计算up向量值		upX=tempx-cameraX;		upZ=tempz-cameraZ;		ms.setCamera(cameraX,cameraY,cameraZ,targetX,targetY,targetZ,upX,upY,upZ);//设置摄像机		//设置光源位置		lightManager.lx=cameraX;		lightManager.ly=cameraY;		lightManager.lz=cameraZ;	}	function init()//初始化模型名和模型纹理图名	{		if(uriIndex=="0")		{			imageName="building2.jpg";			objName="building2.obj";						cameraZ=1050;//摄像机z位置				targetY=26;//目标点y位置			tempz=upZ+cameraZ;//中间值z			tempLimit=tempz;			currSightDis=1000;//摄像机和目标的距离			displaySize=16;//每一块的尺寸				bs=1;//树的倍数		}else if(uriIndex=="1")		{			imageName="building4.jpg";			objName="building4.obj";						cameraZ=2200;//摄像机z位置				targetY=66;//目标点y位置			tempz=upZ+cameraZ;//中间值z			tempLimit=tempz;			currSightDis=2400;//摄像机和目标的距离						displaySize=34;//每一块的尺寸			bs=2.1;//树的倍数		}else if(uriIndex=="2")		{			imageName="building5.jpg";			objName="building5.obj";						cameraZ=1600;//摄像机z位置				targetY=42;//目标点y位置			tempz=upZ+cameraZ;//中间值z			tempLimit=tempz;			currSightDis=1600;//摄像机和目标的距离						displaySize=26;//每一块的尺寸			bs=1.6;//树的倍数		}else if(uriIndex=="3")		{			imageName="building8.jpg";			objName="building8.obj";						cameraZ=1200;//摄像机z位置				targetY=32;//目标点y位置			tempz=upZ+cameraZ;//中间值z			tempLimit=tempz;			currSightDis=1200;//摄像机和目标的距离						displaySize=20;//每一块的尺寸			bs=1.25;//树的倍数		}		LookAroundCamera();//设置摄像机	}	function initAll()	{		if(step==0)		{			init();//初始化模型名和模型纹理图名			step++;		}else if(step==1)		{    			loadShaderFile("shader/shader_nolight2.bns",1);//不带光照，不会被反射的物体			step++;		}else if(step==2)		{			loadShaderFile("shader/shader.bns",0);//带光照的物体			step++;		}else if(step==3)		{			//加载纹理图			loadImageTexture(gl, "pic/"+imageName,"buildingTex");//加载楼房图片			loadImageTexture(gl, "pic/bg.jpg","bg");//加载背景图片			loadImageTexture(gl, "pic/grass1.jpg","grass");//加载草坪图片			step++;		}else if(step==4)		{			loadImageTexture(gl, "pic/road3.jpg","stone2");//加载石子路图片			loadImageTexture(gl, "pic/label7_1.jpg","label7_1");//加载三室一厅			loadImageTexture(gl, "pic/label7_2.jpg","label7_2");//加载三室一厅			step++;		}else if(step==5)		{			loadImageTexture(gl, "pic/label8_1.jpg","label8_1");//加载二室一厅			loadImageTexture(gl, "pic/label8_2.jpg","label8_2");//加载二室一厅			loadImageTexture(gl, "pic/label9_1.jpg","label9_1");//加载一室一厅			step++;		}else if(step==6)		{			loadImageTexture(gl, "pic/label9_2.jpg","label9_2");//加载一室一厅			loadImageTexture(gl, "pic/huxing.jpg","huxing");//加载户型展示图			loadImageTexture(gl, "pic/return.jpg","returnTex");//加载返回按钮图片			loadImageTexture(gl, "pic/tree.jpg","chuiliu");//加载树纹理图			step++;		}else if(step==7)		{			//加载模型以及绘制者			loadHouseObjFile("obj/"+objName,0); //加载房子模型			step++;		}else if(step==8)		{			loadObjFile("obj/rectangle.obj",2,1);//矩形绘制对象模型			step++;		}else if(step==9)		{			loadObjFile("obj/caoping.obj",4,1); //草坪模型			step++;		}else if(step==10)		{			loadPalntObjFile("obj/zonglvTree.obj",4,1);//加载树模型			step++;		}else if(step==11)		{			button=new DrawButton();//创建绘制按钮对象			step++;			return;		}	}		function drawSurrounding()//绘制环绕的房屋建筑	{			//绘制环绕的房屋建筑		gl.viewport(200, 0, canvas.width, canvas.height);//设置视口		//绘制房子		ms.pushMatrix();//保护现场		building.drawSelf(ms,texMap["buildingTex"]);//绘制房子模型		ms.popMatrix();//恢复现场		//绘制草坪		for(var i=0;i<mapsData7.length/3;i++)		{			ms.pushMatrix();			ms.translate(-displaySize*2+mapsData7[i*3]*displaySize,0,-displaySize*2+mapsData7[(i*3+1)]*displaySize);			ms.scale(displaySize,1,displaySize);			grand.drawSelf(ms,texMap[mapsData7[(i*3+2)]]);//草坪			ms.popMatrix();		}		//绘制高8米的树		for(var i=0;i<point0.length/2;i++)		{			ms.pushMatrix();			ms.translate(point0[i*2]*bs,0,point0[i*2+1]*bs);			ms.scale(4*bs,8*bs,5*bs);			trees[4].drawSelf(ms,texMap["chuiliu"]);//植物			ms.popMatrix();		}		//绘制高10米的树		for(var i=0;i<point1.length/2;i++)		{			ms.pushMatrix();			ms.translate(point1[i*2]*bs,0,point1[i*2+1]*bs);			ms.scale(6*bs,10*bs,8*bs);			trees[4].drawSelf(ms,texMap["chuiliu"]);//植物			ms.popMatrix();		}		//绘制高6米的树		for(var i=0;i<point2.length/2;i++)		{			ms.pushMatrix();			ms.translate(point2[i*2]*bs,0,point2[i*2+1]*bs);			ms.scale(3*bs,6*bs,4*bs);			trees[4].drawSelf(ms,texMap["chuiliu"]);//植物			ms.popMatrix();		}		gl.viewport(0, 0, canvas.width, canvas.height);//恢复视口	}	//绘制一帧画面的方法	function drawFrame()	{		if(step!=12)		{			initAll();//加载资源			return;		}		if((!building)||(!rectangle)||(!grand)||(!trees[4]))		{			//alert("houseModel.html not over.....");			return;		}	    //清除着色缓冲与深度缓冲	    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);				//绘制背景图		ms2D.pushMatrix(); //保护现场		ms2D.scale(fromPixWIDTHToNearWIDTH(48),fromPixHEIGHTToNearHEIGHT(12),1);		rectangle.drawSelf(ms2D,texMap["bg"]);//绘制背景图		ms2D.popMatrix();//恢复现场					//开启深度检测	    gl.enable(gl.DEPTH_TEST);				//绘制展示的楼房与草坪		drawSurrounding();				//绘制按钮		ms2D.pushMatrix(); //保护现场		 //开启混合        gl.enable(gl.BLEND);          //设置混合因子        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);		//绘制按钮		button.drawSelf(ms2D);		//关闭混合        gl.disable(gl.BLEND);		ms2D.popMatrix();				//关闭深度检测	    gl.disable(gl.DEPTH_TEST);				if(isRoomType)		{//转到浏览户型的页面			if(count<8)			{				count++;//停顿时间加一			}else			{				document.location.href="roomType.html?param="+roomTypeIndex+";"+uriIndex;//向浏览户型的页面传递参数				isRoomType=false;//设置转到浏览户型的页面的标志位				count=0;//停顿时间恢复0				ONE=0;//按钮图片索引值还原				TWO=2;//按钮图片索引值还原				THREE=4;//按钮图片索引值还原			}		}else if(isReturn)		{//返回到主界面			document.location.href="mainView.html";//跳转页面			isReturn=false;//设置是否返回主界面标志位		}	}   	</script></head><body onload="start();">	<div id="Layer1" style="position:absolute; width:94%; height:95%; z-index:-1">    		<img src="pic/loading.jpg" height="600" width="1200"/>    	</div>  	<canvas height="600" width="1200" id="bncanvas">	    若看到这个文字，说明浏览器不支持WebGL!	</canvas>  </body></html>