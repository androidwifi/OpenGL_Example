<html><head>	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />  <title>户体模型</title>  <!--库js的引入-->  	<script type="text/javascript" src="js/util/Matrix.js"></script>	<script type="text/javascript" src="js/util/MatrixState.js"></script>		<script type="text/javascript" src="js/util/GLUtil.js"></script>		<script type="text/javascript" src="js/util/LoadShaderUtil.js"></script>	<script type="text/javascript" src="js/util/LoadObjUtil.js"></script>	<script type="text/javascript" src="js/util/ObjObject.js"></script>	<script type="text/javascript" src="js/util/LightManager.js"></script>	<script type="text/javascript" src="js/util/FrameGlobalVar.js"></script>	<!--应用特有js的引入-->	<script type="text/javascript" src="js/roomType/RoomTypeVar.js"></script>	<script type="text/javascript" src="js/roomType/loadRoomType.js"></script>	<script type="text/javascript" src="js/loadObject.js"></script>	<script type="text/javascript" src="js/PointTransformUtil.js"></script>	  	<script>	var mPreviousY;//上次的触控位置Y坐标    var mPreviousX;//上次的触控位置X坐标	var down=false;//鼠标是否按下标志位	var step=0;//加载资源步数		document.onmousedown = function(event)	{		var mouseX=fromScreenTo2DWordX(event.pageX);//获取触控点在3D中的坐标x		var mouseY=fromScreenTo2DWordY(event.pageY);//获取触控点在3D中的坐标y		if((mouseX>return_minX&&mouseX<return_maxX)		&&(mouseY>return_minY&&mouseY<return_maxY))//判断是否点中返回按钮		{			isReturn=true;//返回主界面标志位		}		mPreviousX=event.pageX;//获取触控点x坐标		mPreviousY=event.pageY;//获取触控点y坐标		down=true;//按下鼠标	}	document.onmousemove = function(event)//鼠标移动	{			if(down)//按下鼠标		{			var moveX=event.pageX;//获取移动点x坐标			var moveY=event.pageY;//获取移动点y坐标						var dx = moveX- mPreviousX;//计算触控笔X位移			var dy = moveY - mPreviousY;//计算触控笔Y位移			//不超过阈值不移动摄像机			if(Math.abs(dx)<7 && Math.abs(dy)<7){				return;			}            			angdegAzimuth += dx * TOUCH_SCALE_FACTOR;//设置沿x轴旋转角度			angdegElevation += dy * TOUCH_SCALE_FACTOR;//设置沿z轴旋转角度			//将仰角限制在5～90度范围内			angdegElevation = Math.max(angdegElevation, 5);			angdegElevation = Math.min(angdegElevation, 90);		}		mPreviousX=event.pageX;//设置当前点为移动点x坐标		mPreviousY=event.pageY;//设置当前点为移动点y坐标	}	document.onmouseup = function(event)	{		mPreviousX=event.pageX;//获取抬起点x坐标		mPreviousY=event.pageY;//获取抬起点y坐标		down=false;//抬起鼠标	}	//给页面绑定滑轮滚动事件  	if (document.addEventListener) {//firefox  		document.addEventListener('DOMMouseScroll', scrollFunc, false);  	}  	//滚动滑轮触发scrollFunc方法  //ie 谷歌  	window.onmousewheel = document.onmousewheel = scrollFunc; 		function scrollFunc(e)	{//滚轮事件		e = e || window.event;		if (e.wheelDelta) {  //判断浏览器IE，谷歌滑轮事件               			if (e.wheelDelta > 0) { //当滑轮向上滚动时				if(bs>1)				{					bs=bs-0.05;//缩小				}			}  			if (e.wheelDelta < 0) { //当滑轮向下滚动时								if(bs<=1.3)				{					bs=bs+0.05;//放大				}			}  		} else if (e.detail) {  //Firefox滑轮事件  			if (e.detail> 0) { //当滑轮向上滚动时  				if(bs>1)				{					bs=bs-0.05;//缩小				}			}  			if (e.detail< 0) { //当滑轮向下滚动时								if(bs<=1.3)				{					bs=bs+0.05;//放大				}			}  		}	}		//初始化的方法  	function start()	{    				var url=window.location .href;		var aa=url.indexOf('=');//找到url中"="的索引		if (aa>-1){//如果url中存在"="			uriIndex=url.substring(aa+1,aa+2);//得到"="后面的内容			uriIndex1=url.substring(aa+3);//得到楼房id			//alert(uriIndex+":"+uriIndex1);		}	    //获取GLES上下文	    gl = initWebGLCanvas("bncanvas");	    if (!gl) 	    {			alert("创建GLES上下文失败!");			return;	    }    	    //初始化3D画布参数	    var canvas = document.getElementById('bncanvas');				//设置视口	    gl.viewport(0, 0, canvas.width, canvas.height);		var ratio=canvas.width/canvas.height;			    //设置屏幕背景色RGBA---红色		gl.clearColor(0.886,0.851,0.82,1.0);		gl.enable(gl.DEPTH_TEST);//打开深度检测		//初始化2D变化矩阵		ms2D.setInitStack();		ms2D.setProjectOrtho(-ratio,ratio,-Vtop,Vtop,1,Vfar);//设置投影		ms2D.setCamera(0,0,1,0,0,0,0,1,0);//设置摄像机				    //初始化变换矩阵	    ms1.setInitStack();	    //设置投影	    ms1.setProjectFrustum(-ratio,ratio,-Vtop,Vtop,Vnear,Vfar);				    //绘制画面	    setInterval("drawFrame();",30);	}		function init()//初始化模型名和模型纹理图名	{		if(uriIndex=="0")		{			imageName="housemodel1.jpg";			objName="housemodel1.obj";		}else if(uriIndex=="1")		{			imageName="housemodel2.jpg";			objName="housemodel2.obj";		}else if(uriIndex=="2")		{			imageName="housemodel3.jpg";			objName="housemodel3.obj";		}		//alert("++++++++"+uriIndex);	}	function initALL()//加载资源	{		if(step==0)		{			init();//初始化模型名和模型纹理图名			step++;		}else if(step==1)		{			//加载着色器			loadShaderFile("shader/shader.bns",0);//带光照的物体			step++;		}else if(step==2)		{			//加载模型以及绘制者 			loadRoomTypeObjFile("obj/"+objName,0);//加载户型模型			step++;		}else if(step==3)		{			//加载纹理图			loadImageTexture(gl, "pic/"+imageName,"housemodelTex");//加载户型纹理图			loadImageTexture(gl, "pic/bg.jpg","bg");//加载背景纹理图			step++;		}else if(step==4)		{			//加载着色器			loadShaderFile("shader/shader_nolight2.bns",1);//不带光照，不会被反射的物体			step++;		}else if(step==5)		{			loadObjFile("obj/rectangle.obj",2,1);//矩形绘制对象模型			step++;		}else if(step==6)		{			loadImageTexture(gl, "pic/return.jpg","returnTex");//返回纹理图			step++;					}else if(step==7||step==8||step==9)		{			step++;		}else if(step==10)		{			step++;			return;		}	}	 //设置摄像机位置的方法	function setCameraPostion(){		//计算摄像机的位置		var angradElevation = angdegElevation*0.017453;//仰角（弧度）		var angradAzimuth = angdegAzimuth*0.017453;//方位角				cameraX = (targetX - currSightDis * Math.cos(angradElevation)* Math.sin(angradAzimuth));		cameraY = (targetY + currSightDis * Math.sin(angradElevation));		cameraZ =  (targetZ - currSightDis * Math.cos(angradElevation) * Math.cos(angradAzimuth));				tempx=Math.sin(angradAzimuth)*tempLimit;		tempz=Math.cos(angradAzimuth)*tempLimit;		//计算up向量值		upX=tempx-cameraX;		upZ=tempz-cameraZ;			} 	//绘制一帧画面的方法	function drawFrame()	{		if(step!=11)		{			initALL();//加载资源			return;		}		if(!housemodel||(!rectangle))//模型还没有加载完		{			//alert(".........");			return;		}	    //清除着色缓冲与深度缓冲	    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);		//设置摄像机的位置		setCameraPostion();				//绘制横幅		ms2D.pushMatrix(); 		ms2D.scale(fromPixWIDTHToNearWIDTH(48),fromPixHEIGHTToNearHEIGHT(12),1);		rectangle.drawSelf(ms2D,texMap["bg"]);//绘制横幅		ms2D.popMatrix();				//开启深度检测	    gl.enable(gl.DEPTH_TEST);					//户体模型绘制		ms1.pushMatrix();				//设置camera位置		ms1.setCamera(cameraX,cameraY,cameraZ,targetX,targetY,targetZ,upX,upY,upZ);//设置摄像机		ms1.scale(bs,bs,bs);//缩放				ms1.pushMatrix();		housemodel.drawSelf(ms1,texMap["housemodelTex"]);//绘制室内模型		ms1.popMatrix();//恢复现场		ms1.popMatrix();				//绘制返回按钮		ms2D.pushMatrix();		//开启混合        gl.enable(gl.BLEND);          //设置混合因子        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);		ms2D.pushMatrix(); 		ms2D.translate(returnX,returnY,0);		ms2D.scale(0.005,0.005,1);//0.25,0.25		rectangle.drawSelf(ms2D,texMap["returnTex"]);//绘制返回按钮		ms2D.popMatrix();		//关闭混合        gl.disable(gl.BLEND);        ms2D.popMatrix();				//关闭深度检测	    gl.disable(gl.DEPTH_TEST);				if(isReturn)		{//返回到主界面			document.location.href="houseModel.html?param="+uriIndex1+"";			isReturn=false;		}	}   	</script></head><body onload="start();">	<div id="Layer1" style="position:absolute; width:94%; height:95%; z-index:-1">    		<img src="pic/loading.jpg" height="600" width="1200"/>    	</div>  	<canvas height="600" width="1200" id="bncanvas">	    若看到这个文字，说明浏览器不支持WebGL!	</canvas></body></html>